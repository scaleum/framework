[Вернуться к оглавлению](../../index.md)
# Stream

`Stream` — реализация PSR-7 `StreamInterface`, обёртка над ресурсом PHP для работы с потоками. Обеспечивает чтение, запись, позиционирование и получение метаданных.

## Назначение

- Управление ресурсом PHP (`resource`) в виде потока.
- Поддержка операций чтения/записи (`read()`, `write()`), проверки доступности (`isReadable()`, `isWritable()`).
- Управление позицией потока (`seek()`, `rewind()`, `tell()`).
- Получение размера, содержимого и метаданных потока.
- Безопасное закрытие и отделение ресурса.

## Конструктор

```php
public function __construct($resource)
```

- `$resource` — валидный PHP-ресурс (например, результат `fopen()`).
- При невалидном ресурсе бросает `RuntimeException`.
- Определяет флаги `$seekable`, `$readable`, `$writable` по параметрам потока.

## Методы

| Метод                                      | Описание                                                                         |
|:-------------------------------------------|:---------------------------------------------------------------------------------|
| `__toString(): string`                     | Возвращает весь контент потока как строку; при необходимости `rewind()`.          |
| `close(): void`                            | Закрывает ресурс потока, если он открыт.                                         |
| `detach()`                                 | Отсоединяет и возвращает ресурс, делает поток недоступным для операций.           |
| `getSize(): ?int`                          | Возвращает размер потока (байтов) или `null`, если неизвестен.                   |
| `tell(): int`                              | Возвращает текущую позицию указателя потока; бросает `RuntimeException` при ошибке.
| `eof(): bool`                              | Проверяет, достигнут ли конец потока или ресурс закрыт.                          |
| `isSeekable(): bool`                       | Проверяет, поддерживает ли поток операции `seek()`.                              |
| `seek(int $offset, int $whence = SEEK_SET): void` | Перемещает указатель потока; может бросить `RuntimeException`.            |
| `rewind(): void`                           | Перемещает указатель потока в начало (`seek(0)`).                                 |
| `isWritable(): bool`                       | Проверяет, можно ли записывать в поток.                                          |
| `write(string $string): int`               | Записывает строку в поток, возвращает число записанных байт; бросает исключение.  |
| `isReadable(): bool`                       | Проверяет, можно ли читать из потока.                                            |
| `read(int $length): string`                | Читает до `$length` байт из потока, возвращает строку; бросает исключение.        |
| `getContents(): string`                    | Читает остаток потока от текущей позиции до конца.                                |
| `getMetadata(string $key = null): mixed`   | Возвращает весь массив метаданных или значение по ключу.                         |

## Примеры использования

### 1. Работа с временным потоком (Memory Stream)
```php
use Scaleum\Http\Stream;

$stream = new Stream(fopen('php://temp', 'r+'));

// Запись строки
$bytes = $stream->write("Hello, Stream!\n"); // возвращает число байт

// Перемещение в начало и чтение содержимого
$stream->rewind();
echo $stream->getContents(); // "Hello, Stream!\n"
```

### 2. Использование __toString()
```php
$stream = new Stream(fopen('php://temp', 'r+'));
$stream->write("Line1\nLine2\n");
// __toString автоматически выполнит rewind() перед чтением
echo (string)$stream;
// Выведет:
// Line1
// Line2
```

### 3. Отделение ресурса и передача другому объекту
```php
$resource = fopen('/path/to/file.txt', 'rb');
$stream   = new Stream($resource);

// Отделяем ресурс для прямого доступа
$fileResource = $stream->detach();
// Теперь $stream недоступен для чтения/записи
fclose($fileResource); // закрываем вручную
```

### 4. Получение размера и метаданных
```php
$stream = new Stream(fopen('php://temp', 'r+'));
$stream->write(str_repeat('A', 1024));

// Размер в байтах
echo $stream->getSize(); // 1024

// Метаданные потока
$meta = $stream->getMetadata();
echo $meta['mode']; // например, 'r+'
```

### 5. Работа с файловыми потоками
```php
$stream = new Stream(fopen('/var/log/app.log', 'r'));

// Читаем первые 100 байт
$data = $stream->read(100);

while (! $stream->eof()) {
    $data = $stream->read(4096);
    // Обработка чанка данных...
}

$stream->close(); // закрываем файл
```

[Вернуться к оглавлению](../../index.md)