name: Date Tag Release

on:
  push:
    branches: [ master ]   # измени, если у тебя другая ветка
  workflow_dispatch:      # позволит запускать вручную из UI

env:
  MAJOR: "1"              # поменяешь при необходимости
  MINOR: "0"

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }  # нужен полный список тегов

      # (опционально) задать MAJOR/MINOR из ручного запуска
      - name: Override MAJOR/MINOR from inputs
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "MAJOR=${{ github.event.inputs.major || env.MAJOR }}" >> $GITHUB_ENV
          echo "MINOR=${{ github.event.inputs.minor  || env.MINOR }}" >> $GITHUB_ENV

      - name: Calculate next date tag
        id: calc
        shell: bash
        run: |
          set -e
          DATE=$(date -u '+%Y%m%d')             # один сегмент даты
          PREFIX="${MAJOR}.${MINOR}.${DATE}"

          git fetch --tags --force
          LAST=$(
            git tag -l "${PREFIX}.*" \
            | awk -F. '{print $NF}' \
            | grep -E '^[0-9]+$' || true
          )
          if [ -z "$LAST" ]; then
            NEXT=0
          else
            NEXT=$(printf "%s\n" "$LAST" | sort -n | tail -1)
            NEXT=$((NEXT + 1))
          fi
          echo "TAG=${PREFIX}.${NEXT}" >> $GITHUB_OUTPUT

      - name: Create and push tag
        shell: bash
        run: |
          TAG="${{ steps.calc.outputs.TAG }}"
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Tag ${TAG} уже существует — пропускаю"
          else
            git tag -a "${TAG}" -m "Release ${TAG}"
            git push origin "${TAG}"
          fi
