name: Release (SemVer)
on:
  push:
    branches: [ master ]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      # 0) Гард: если нет 1.0.0 — создаём его один раз
      - name: Ensure baseline tag 1.0.0
        shell: bash
        run: |
          set -e
          git fetch --tags --force
          if git rev-parse -q --verify "refs/tags/1.0.0" >/dev/null; then
            echo "baseline 1.0.0 already exists"
          else
            echo "creating baseline 1.0.0"
            git config user.name  "${{ github.actor }}"
            git config user.email "${{ github.actor }}@users.noreply.github.com"
            git tag -a 1.0.0 -m "baseline: start 1.x line"
            git push origin 1.0.0
          fi

      # 1) Авто-вычисление НОВОГО тега по conventional commits
      # feat: -> MINOR, fix: -> PATCH, ! или BREAKING CHANGE -> MAJOR
      - name: Bump version (SemVer)
        id: bump
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release_branches: master
          default_bump: patch
          tag_prefix: ""
          initial_version: 1.0.0   # работает только если вообще нет тегов

      # 2) (опционально) прошить версию в PHP-код
      - name: Patch Version::VERSION
        if: ${{ steps.bump.outputs.new_tag != '' }}
        run: |
          TAG="${{ steps.bump.outputs.new_tag }}"
          php -r '
            $f = "src/Core/Version.php";
            if (!file_exists($f)) { exit(0); }
            $c = file_get_contents($f);
            $c = preg_replace("/const VERSION = \x27[^\\x27]*\x27;/", "const VERSION = \x27'.$TAG."\x27;", $c, 1);
            file_put_contents($f, $c);
          '
          git config user.name  "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git commit -am "chore: set version ${{ steps.bump.outputs.new_tag }}" || echo "no changes"
          git push || true

      # 3) Релиз под новый тег
      - name: Create GitHub Release
        if: ${{ steps.bump.outputs.new_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.bump.outputs.new_tag }}
          name: ${{ steps.bump.outputs.new_tag }}
          generate_release_notes: true # автоматически сгенерировать заметки к релизу
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
